<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - CodeElite</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
    <style>
        .dashboard {
            margin-top: 100px;
            padding: 40px 0;
        }
        
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }
        
        .stat-card {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            text-align: center;
        }
        
        .stat-card i {
            font-size: 2.5rem;
            color: #3b82f6;
            margin-bottom: 1rem;
        }
        
        .stat-card h3 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: #1e293b;
        }
        
        .stat-card p {
            color: #64748b;
        }
        
        .dashboard-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .tab {
            padding: 1rem 2rem;
            background: none;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            color: #64748b;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 0.5rem 0;
        }
        
        .progress-fill {
            height: 100%;
            background: #3b82f6;
            border-radius: 4px;
        }

        /* ✅ Profile Picture Styles */
        .profile-header {
            display: flex;
            align-items: center;
            gap: 2rem;
            margin-bottom: 2rem;
            padding: 2rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .profile-avatar {
            position: relative;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            overflow: hidden;
            border: 4px solid #3b82f6;
        }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-upload {
            position: absolute;
            bottom: 0;
            right: 0;
            background: #3b82f6;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .avatar-upload:hover {
            background: #2563eb;
            transform: scale(1.1);
        }

        .avatar-upload input {
            display: none;
        }

        .profile-info h2 {
            margin: 0 0 0.5rem 0;
            color: #1e293b;
        }

        .profile-info p {
            margin: 0;
            color: #64748b;
        }

        .profile-role {
            display: inline-block;
            background: #dbeafe;
            color: #1e40af;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <span class="logo-icon"><i class="fas fa-graduation-cap"></i></span>
                    <h1>CodeElite</h1>
                </div>
                <nav>
                    <ul>
                        <li><a href="../index.html"><i class="fas fa-home"></i> Home</a></li>
                        <li><a href="courses.html"><i class="fas fa-book-open"></i> Courses</a></li>
                        <li><a href="#"><i class="fas fa-chalkboard-teacher"></i> Instructors</a></li>
                        <li><a href="videos.html"><i class="fas fa-video"></i> Videos</a></li>
                        <li><a href="#"><i class="fas fa-info-circle"></i> About</a></li>
                        <li><a href="dashboard.html" class="active"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                    </ul>
                </nav>
                <div class="auth-buttons">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </header>

    <!-- Dashboard -->
    <section class="dashboard">
        <div class="container">
            <!-- ✅ Profile Header with Picture -->
            <div class="profile-header" id="profileHeader">
                <div class="profile-avatar">
                    <img id="currentAvatar" src="" alt="Profile Picture">
                    <label class="avatar-upload" for="profileAvatar">
                        <i class="fas fa-camera"></i>
                        <input type="file" id="profileAvatar" accept="image/*">
                    </label>
                </div>
                <div class="profile-info">
                    <h2 id="profileUserName">Loading...</h2>
                    <p id="profileUserEmail">Loading...</p>
                    <span class="profile-role" id="profileUserRole">Student</span>
                </div>
            </div>

            <h1 style="margin-bottom: 2rem; color: #1e293b;">Student Dashboard</h1>
            
            <!-- Stats -->
            <div class="dashboard-stats">
                <div class="stat-card">
                    <i class="fas fa-book-open"></i>
                    <h3 id="enrolledCoursesCount">0</h3>
                    <p>Enrolled Courses</p>
                </div>
                <div class="stat-card">
                    <i class="fas fa-clock"></i>
                    <h3 id="totalHours">0</h3>
                    <p>Learning Hours</p>
                </div>
                <div class="stat-card">
                    <i class="fas fa-certificate"></i>
                    <h3 id="completedCourses">0</h3>
                    <p>Completed Courses</p>
                </div>
                <div class="stat-card">
                    <i class="fas fa-trophy"></i>
                    <h3 id="achievements">5</h3>
                    <p>Achievements</p>
                </div>
            </div>
            
            <!-- Tabs -->
            <div class="dashboard-tabs">
                <button class="tab active" data-tab="enrolled">Enrolled Courses</button>
                <button class="tab" data-tab="progress">Learning Progress</button>
                <button class="tab" data-tab="achievements">Achievements</button>
                <button class="tab" data-tab="profile">Profile Settings</button>
            </div>
            
            <!-- Tab Contents -->
            <div class="tab-content active" id="enrolled-tab">
                <h2 style="margin-bottom: 2rem;">My Enrolled Courses</h2>
                <div class="courses-grid" id="enrolledCoursesGrid">
                    <div class="loading-message">Loading your courses...</div>
                </div>
            </div>
            
            <div class="tab-content" id="progress-tab">
                <h2 style="margin-bottom: 2rem;">Learning Progress</h2>
                <div class="courses-grid" id="progressCoursesGrid">
                    <div class="loading-message">Loading progress data...</div>
                </div>
            </div>
            
            <div class="tab-content" id="achievements-tab">
                <h2 style="margin-bottom: 2rem;">My Achievements</h2>
                <div class="features">
                    <div class="feature-card">
                        <div class="feature-icon"><i class="fas fa-graduation-cap"></i></div>
                        <h3>First Course Completed</h3>
                        <p>Completed your first course on CodeElite</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon"><i class="fas fa-star"></i></div>
                        <h3>Perfect Score</h3>
                        <p>Achieved 100% in a course assessment</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon"><i class="fas fa-bolt"></i></div>
                        <h3>Fast Learner</h3>
                        <p>Completed a course in record time</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon"><i class="fas fa-users"></i></div>
                        <h3>Community Contributor</h3>
                        <p>Helped other students in the forum</p>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="profile-tab">
                <h2 style="margin-bottom: 2rem;">Profile Settings</h2>
                <div class="upload-form">
                    <form id="profileForm">
                        <div class="form-group">
                            <label for="profileName"><i class="fas fa-user"></i> Full Name</label>
                            <input type="text" id="profileName" class="form-control" placeholder="Enter your full name">
                        </div>
                        
                        <div class="form-group">
                            <label for="profileEmail"><i class="fas fa-envelope"></i> Email Address</label>
                            <input type="email" id="profileEmail" class="form-control" placeholder="Enter your email">
                        </div>
                        
                        <div class="form-group">
                            <label for="profileBio"><i class="fas fa-align-left"></i> Bio</label>
                            <textarea id="profileBio" class="form-control" placeholder="Tell us about yourself" rows="4"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label><i class="fas fa-camera"></i> Profile Picture</label>
                            <div style="display: flex; align-items: center; gap: 1rem; margin-top: 0.5rem;">
                                <img id="profileAvatarPreview" src="" alt="Current Avatar" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 2px solid #e2e8f0;">
                                <div>
                                    <input type="file" id="profileAvatarInput" class="form-control" accept="image/*" style="margin-bottom: 0.5rem;">
                                    <small style="color: #64748b;">Max file size: 5MB. Supported formats: JPG, PNG, GIF</small>
                                </div>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary" style="width: 100%; padding: 1.2rem;">
                            <i class="fas fa-save"></i> Update Profile
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-column">
                    <h3>CodeElite</h3>
                    <p>Your gateway to mastering technical skills through high-quality video courses.</p>
                    <div class="social-links">
                        <a href="#"><i class="fab fa-facebook-f"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-linkedin-in"></i></a>
                        <a href="#"><i class="fab fa-youtube"></i></a>
                    </div>
                </div>
                
                <div class="footer-column">
                    <h3>Quick Links</h3>
                    <ul>
                        <li><a href="../index.html"><i class="fas fa-chevron-right"></i> Home</a></li>
                        <li><a href="courses.html"><i class="fas fa-chevron-right"></i> All Courses</a></li>
                        <li><a href="#"><i class="fas fa-chevron-right"></i> Become an Instructor</a></li>
                        <li><a href="#"><i class="fas fa-chevron-right"></i> Pricing Plans</a></li>
                        <li><a href="#"><i class="fas fa-chevron-right"></i> Blog</a></li>
                    </ul>
                </div>
                
                <div class="footer-column">
                    <h3>Support</h3>
                    <ul>
                        <li><a href="#"><i class="fas fa-chevron-right"></i> Help Center</a></li>
                        <li><a href="#"><i class="fas fa-chevron-right"></i> Contact Us</a></li>
                        <li><a href="#"><i class="fas fa-chevron-right"></i> FAQ</a></li>
                        <li><a href="#"><i class="fas fa-chevron-right"></i> Terms of Service</a></li>
                        <li><a href="#"><i class="fas fa-chevron-right"></i> Privacy Policy</a></li>
                    </ul>
                </div>
                
                <div class="footer-column">
                    <h3>Contact Info</h3>
                    <ul>
                        <li><a href="#"><i class="fas fa-envelope"></i> support@codeelite.com</a></li>
                        <li><a href="#"><i class="fas fa-phone"></i> +1 (555) 123-4567</a></li>
                        <li><a href="#"><i class="fas fa-map-marker-alt"></i> 123 Tech Street, San Francisco, CA</a></li>
                    </ul>
                </div>
            </div>
            
            <div class="copyright">
                <p>&copy; 2023 CodeElite. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="../js/script.js"></script>
    <script>
        // Dashboard specific functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Tab functionality
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Remove active class from all tabs and contents
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    
                    // Add active class to clicked tab and corresponding content
                    tab.classList.add('active');
                    const tabId = tab.dataset.tab + '-tab';
                    document.getElementById(tabId).classList.add('active');
                });
            });
            
            // Load user data
            if (Auth.isAuthenticated()) {
                loadDashboardData();
            } else {
                window.location.href = 'login.html';
            }
            
            // Profile form handling
            const profileForm = document.getElementById('profileForm');
            if (profileForm) {
                profileForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    updateUserProfile();
                });
            }

            // Avatar upload functionality
            const avatarInput = document.getElementById('profileAvatar');
            const profileAvatarInput = document.getElementById('profileAvatarInput');
            
            if (avatarInput) {
                avatarInput.addEventListener('change', function(e) {
                    handleAvatarUpload(this.files[0]);
                });
            }
            
            if (profileAvatarInput) {
                profileAvatarInput.addEventListener('change', function(e) {
                    const file = this.files[0];
                    if (file) {
                        previewAvatar(file, 'profileAvatarPreview');
                    }
                });
            }
        });
        
        async function loadDashboardData() {
            try {
                // Load user profile first
                const profile = await UserAPI.getProfile();
                if (profile.success) {
                    updateProfileHeader(profile.data);
                    updateProfileForm(profile.data);
                }
                
                // Load enrolled courses
                const enrolledCourses = await UserAPI.getEnrolledCourses();
                if (enrolledCourses.success) {
                    updateEnrolledCourses(enrolledCourses.data);
                    updateStats(enrolledCourses.data);
                } else {
                    document.getElementById('enrolledCoursesGrid').innerHTML = 
                        '<p>Error loading courses. Please try again.</p>';
                }
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                document.getElementById('enrolledCoursesGrid').innerHTML = 
                    '<p>Error loading dashboard data. Please check your connection.</p>';
            }
        }

        // ✅ Update profile header with user info and avatar
        function updateProfileHeader(user) {
            document.getElementById('profileUserName').textContent = user.name || 'User';
            document.getElementById('profileUserEmail').textContent = user.email || '';
            document.getElementById('profileUserRole').textContent = user.role || 'Student';
            
            // Set avatar image
            const avatarUrl = user.avatar && user.avatar !== 'default-avatar.png' 
                ? `/uploads/avatars/${user.avatar}`
                : getDefaultAvatar(user.name);
            
            document.getElementById('currentAvatar').src = avatarUrl;
            document.getElementById('profileAvatarPreview').src = avatarUrl;
        }

        // ✅ Get default avatar based on user name
        function getDefaultAvatar(name) {
            const colors = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6'];
            const char = name ? name.charAt(0).toUpperCase() : 'U';
            const color = colors[char.charCodeAt(0) % colors.length];
            
            return `data:image/svg+xml;base64,${btoa(`
                <svg width="200" height="200" xmlns="http://www.w3.org/2000/svg">
                    <rect width="100%" height="100%" fill="${color}"/>
                    <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" 
                          fill="white" font-family="Arial" font-size="80" font-weight="bold">
                        ${char}
                    </text>
                </svg>
            `)}`;
        }

        // ✅ Preview avatar before upload
        function previewAvatar(file, previewElementId) {
            const reader = new FileReader();
            const preview = document.getElementById(previewElementId);
            
            reader.onload = function(e) {
                preview.src = e.target.result;
            }
            
            reader.readAsDataURL(file);
        }

        // ✅ Handle avatar upload
        async function handleAvatarUpload(file) {
            if (!file) return;
            
            try {
                // Validate file type and size
                if (!file.type.startsWith('image/')) {
                    UI.showAlert('Please select a valid image file', 'error');
                    return;
                }
                
                if (file.size > 5 * 1024 * 1024) {
                    UI.showAlert('Image size should be less than 5MB', 'error');
                    return;
                }
                
                UI.showAlert('Uploading avatar...', 'info');
                
                // Create FormData for file upload
                const formData = new FormData();
                formData.append('avatar', file);
                
                // Update profile with new avatar
                const result = await updateProfileWithAvatar(formData);
                
                if (result.success) {
                    UI.showAlert('Profile picture updated successfully!');
                    // Update the avatar in header
                    const avatarUrl = URL.createObjectURL(file);
                    document.getElementById('currentAvatar').src = avatarUrl;
                } else {
                    UI.showAlert(result.message || 'Failed to update profile picture', 'error');
                }
                
            } catch (error) {
                console.error('Error uploading avatar:', error);
                UI.showAlert('Error uploading profile picture', 'error');
            }
        }

        // ✅ Update profile with avatar (API call)
        async function updateProfileWithAvatar(formData) {
            try {
                const token = Auth.getToken();
                const response = await fetch('/api/users/profile', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                    },
                    body: formData
                });

                const data = await response.json();
                return data;
            } catch (error) {
                return { success: false, message: 'Network error occurred' };
            }
        }

        function updateStats(enrollments) {
            const enrolledCount = enrollments.length;
            const completedCount = enrollments.filter(e => e.progress === 100).length;
            const totalHours = enrollments.reduce((total, enrollment) => {
                return total + (enrollment.course.duration || 0);
            }, 0);

            document.getElementById('enrolledCoursesCount').textContent = enrolledCount;
            document.getElementById('completedCourses').textContent = completedCount;
            document.getElementById('totalHours').textContent = totalHours;
        }
        
        function updateEnrolledCourses(enrollments) {
            const grid = document.getElementById('enrolledCoursesGrid');
            const countElement = document.getElementById('enrolledCoursesCount');
            
            if (!enrollments || enrollments.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 3rem;">
                        <i class="fas fa-book-open" style="font-size: 3rem; color: #64748b; margin-bottom: 1rem;"></i>
                        <h3 style="color: #64748b; margin-bottom: 1rem;">No Courses Enrolled Yet</h3>
                        <p style="color: #94a3b8; margin-bottom: 2rem;">Start your learning journey by enrolling in courses.</p>
                        <a href="courses.html" class="btn btn-primary">
                            <i class="fas fa-search"></i> Browse Courses
                        </a>
                    </div>
                `;
                countElement.textContent = '0';
                return;
            }
            
            countElement.textContent = enrollments.length;
            
            grid.innerHTML = enrollments.map(enrollment => {
                const course = enrollment.course;
                const imageUrl = course.thumbnail && course.thumbnail !== 'default-thumbnail.jpg' 
                    ? `/uploads/thumbnails/${course.thumbnail}`
                    : getCategoryImage(course.category);
                
                const progress = enrollment.progress || 0;
                const progressColor = progress === 100 ? '#10b981' : '#3b82f6';
                
                return `
                    <div class="course-card">
                        <div class="course-badge">${progress === 100 ? 'Completed' : 'In Progress'}</div>
                        <img src="${imageUrl}" 
                             alt="${course.title}" 
                             class="course-img"
                             onerror="this.src='${getFallbackImage(course.category)}'; this.onerror=null;">
                        <div class="course-content">
                            <h3>${course.title}</h3>
                            <p>${course.description || 'No description available.'}</p>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progress}%; background: ${progressColor}"></div>
                            </div>
                            <div class="course-meta">
                                <span><i class="fas fa-chart-line"></i> Progress: ${progress}%</span>
                                <span><i class="fas fa-clock"></i> ${course.duration || 0} hours</span>
                            </div>
                            <div class="course-actions">
                                <button class="btn btn-primary continue-btn" data-course-id="${course._id}">
                                    <i class="fas fa-play"></i> ${progress === 100 ? 'Review' : 'Continue'}
                                </button>
                                <button class="btn btn-outline view-btn" data-course-id="${course._id}">
                                    <i class="fas fa-eye"></i> View
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Add event listeners to buttons
            grid.querySelectorAll('.continue-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const courseId = e.target.dataset.courseId;
                    continueCourse(courseId);
                });
            });

            grid.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const courseId = e.target.dataset.courseId;
                    viewCourse(courseId);
                });
            });
        }

        function getCategoryImage(category) {
            const categoryImages = {
                'javascript': 'https://images.unsplash.com/photo-1627398242454-45a1465c2479?ixlib=rb-4.0.3&auto=format&fit=crop&w=1000&q=80',
                'python': 'https://images.unsplash.com/photo-1555949963-aa79dcee981c?ixlib=rb-4.0.3&auto=format&fit=crop&w=1000&q=80',
                'react': 'https://images.unsplash.com/photo-1633356122544-f134324a6cee?ixlib=rb-4.0.3&auto=format&fit=crop&w=1000&q=80',
                'cloud': 'https://images.unsplash.com/photo-1544197150-b99a580bb7a8?ixlib=rb-4.0.3&auto=format&fit=crop&w=1000&q=80',
                'default': 'https://images.unsplash.com/photo-1496171367470-9ed9a91ea931?ixlib=rb-4.0.3&auto=format&fit=crop&w=1000&q=80'
            };
            return categoryImages[category] || categoryImages['default'];
        }

        function getFallbackImage(category) {
            const colors = {
                'javascript': '#f7df1e',
                'python': '#3776ab', 
                'react': '#61dafb',
                'cloud': '#ff9900',
                'default': '#3b82f6'
            };
            const color = colors[category] || colors['default'];
            return `data:image/svg+xml;base64,${btoa(`
                <svg width="400" height="200" xmlns="http://www.w3.org/2000/svg">
                    <rect width="100%" height="100%" fill="${color}"/>
                    <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" 
                          fill="white" font-family="Arial" font-size="18" font-weight="bold">
                        ${(category || 'COURSE').toUpperCase()}
                    </text>
                </svg>
            `)}`;
        }
        
        function updateProfileForm(user) {
            document.getElementById('profileName').value = user.name || '';
            document.getElementById('profileEmail').value = user.email || '';
            document.getElementById('profileBio').value = user.bio || '';
        }

        async function updateUserProfile() {
            try {
                const formData = new FormData();
                formData.append('name', document.getElementById('profileName').value);
                formData.append('email', document.getElementById('profileEmail').value);
                formData.append('bio', document.getElementById('profileBio').value);

                // Add avatar file if selected
                const avatarFile = document.getElementById('profileAvatarInput').files[0];
                if (avatarFile) {
                    formData.append('avatar', avatarFile);
                }

                const result = await updateProfileWithAvatar(formData);
                
                if (result.success) {
                    UI.showAlert('Profile updated successfully!');
                    // Update header with new data
                    updateProfileHeader(result.data);
                } else {
                    UI.showAlert(result.message || 'Failed to update profile', 'error');
                }
                
            } catch (error) {
                console.error('Error updating profile:', error);
                UI.showAlert('Error updating profile', 'error');
            }
        }

        function continueCourse(courseId) {
            UI.showAlert(`Continuing course: ${courseId}`);
        }

        function viewCourse(courseId) {
            UI.showAlert(`Viewing course details: ${courseId}`);
        }
    </script>
</body>
</html>